
> xpertkarate-backend@1.0.0 test
> cross-env NODE_ENV=test jest test/tournamentController.test.js test/matchController.test.js test/playerController.test.js

(node:10276) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:4776) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:10344) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
  console.log
    Auto-created organizer profile: new ObjectId("69750f24b359f0b73ed2c3ab")

      at log (src/controllers/tournamentController.js:130:17)

  console.log
    ðŸ”µ Creating tournament with data: {
      tournament_name: 'Test Tournament',
      organizer_id: new ObjectId("69750f24b359f0b73ed2c3ab"),
      start_date: 2026-01-25T18:27:48.088Z,
      end_date: 2026-01-26T18:27:48.091Z,
      registration_deadline: 2026-01-25T06:27:48.091Z,
      status: 'Open'
    }

      at log (src/controllers/tournamentController.js:169:13)

  console.log
    âœ… Tournament created successfully: new ObjectId("69750f24b359f0b73ed2c3ad")

      at log (src/controllers/tournamentController.js:180:13)

  console.log
    âœ… Verified tournament saved to database: new ObjectId("69750f24b359f0b73ed2c3ad")

      at log (src/controllers/tournamentController.js:191:13)

  console.error
    Error: Player validation failed: belt_rank: `Black Belt` is not a valid enum value for path `belt_rank`.
        at ValidationError.inspect (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\mongoose\lib\error\validation.js:50:26)
        at formatValue (node:internal/util/inspect:848:19)
        at inspect (node:internal/util/inspect:386:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2349:40)
        at format (node:internal/util/inspect:2206:10)
        at console.error (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\@jest\console\build\index.js:288:48)
        at error (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\src\middlewares\errorHandler.js:6:11)
        at Layer.handle_error (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\layer.js:71:5)
        at trim_prefix (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:326:13)
        at C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:286:9
        at Function.process_params (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:346:12)
        at next (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:280:10)
        at Layer.handle_error (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\layer.js:67:12)
        at trim_prefix (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:326:13)
        at C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:286:9
        at Function.process_params (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:346:12)
        at next (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:280:10)
        at C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:646:15
        at next (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\index.js:265:14)
        at next (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\express\lib\router\route.js:141:14)
        at next (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\src\controllers\playerController.js:83:5)
        at processTicksAndRejections (node:internal/process/task_queues:105:5) {
      errors: {
        belt_rank: ValidatorError: `Black Belt` is not a valid enum value for path `belt_rank`.
            at validate (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\mongoose\lib\schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\mongoose\lib\schematype.js:1349:7)
            at C:\Users\PC\Desktop\XpertKarate_Final_Year Project\Final_Project\backend\node_modules\mongoose\lib\document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'belt_rank',
          value: 'Black Belt',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'Player validation failed'
    }

    [0m [90m 4 |[39m
     [90m 5 |[39m   [90m// Log error for debugging[39m
    [31m[1m>[22m[39m[90m 6 |[39m   console[33m.[39merror(err)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 7 |[39m
     [90m 8 |[39m   [90m// Mongoose connection/buffering timeout error[39m
     [90m 9 |[39m   [36mif[39m (err[33m.[39mmessage [33m&&[39m err[33m.[39mmessage[33m.[39mincludes([32m'buffering timed out'[39m)) {[0m

      at error (src/middlewares/errorHandler.js:6:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:67:12)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at node_modules/express/lib/router/index.js:646:15
      at next (node_modules/express/lib/router/index.js:265:14)
      at next (node_modules/express/lib/router/route.js:141:14)
      at next (src/controllers/playerController.js:83:5)

  console.log
    Email service is ready

      at log (src/utils/emailService.js:31:15)

  console.log
    Email service is ready

      at log (src/utils/emailService.js:31:15)

  console.log
    ðŸ”„ Checking if next round should be generated for Preliminary in category 69750f24377968b8c7943977

      at log (src/controllers/matchController.js:427:13)

  console.log
    ðŸ“Š Found 1 match(es) in Preliminary round

      at log (src/controllers/matchController.js:459:13)

  console.log
    ðŸ“‹ Match order: To Update

      at log (src/controllers/matchController.js:460:13)

  console.warn
    âš ï¸ Match To Update (69750f24377968b8c7943979) is completed but has no winner_id

    [0m [90m 510 |[39m       
     [90m 511 |[39m       [36mif[39m ([33m![39mcompletedMatch[33m.[39mwinner_id) {
    [31m[1m>[22m[39m[90m 512 |[39m         console[33m.[39mwarn([32m`âš ï¸ Match ${completedMatch.match_name} (${completedMatch._id}) is completed but has no winner_id`[39m)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 513 |[39m         [36mcontinue[39m[33m;[39m
     [90m 514 |[39m       }
     [90m 515 |[39m[0m

      at warn (src/controllers/matchController.js:512:17)

  console.log
    âš ï¸ No winners found for Preliminary round in category 69750f24377968b8c7943977

      at log (src/controllers/matchController.js:578:15)

  console.log
    Auto-created organizer profile: new ObjectId("69750f25b359f0b73ed2c42f")

      at log (src/controllers/tournamentController.js:130:17)

  console.log
    ðŸ”µ Creating tournament with data: {
      tournament_name: 'Original Name',
      organizer_id: new ObjectId("69750f25b359f0b73ed2c42f"),
      start_date: 2026-01-24T18:27:49.347Z,
      end_date: 2026-01-24T18:27:49.347Z,
      registration_deadline: 2026-01-24T18:27:49.347Z,
      status: 'Draft'
    }

      at log (src/controllers/tournamentController.js:169:13)

  console.log
    âœ… Tournament created successfully: new ObjectId("69750f25b359f0b73ed2c431")

      at log (src/controllers/tournamentController.js:180:13)

  console.log
    âœ… Verified tournament saved to database: new ObjectId("69750f25b359f0b73ed2c431")

      at log (src/controllers/tournamentController.js:191:13)

  console.log
    Auto-created organizer profile: new ObjectId("69750f25b359f0b73ed2c45a")

      at log (src/controllers/tournamentController.js:130:17)

  console.log
    ðŸ”µ Creating tournament with data: {
      tournament_name: 'To Delete',
      organizer_id: new ObjectId("69750f25b359f0b73ed2c45a"),
      start_date: 2026-01-24T18:27:49.593Z,
      end_date: 2026-01-24T18:27:49.593Z,
      registration_deadline: 2026-01-24T18:27:49.593Z,
      status: 'Draft'
    }

      at log (src/controllers/tournamentController.js:169:13)

  console.log
    âœ… Tournament created successfully: new ObjectId("69750f25b359f0b73ed2c45c")

      at log (src/controllers/tournamentController.js:180:13)

  console.log
    âœ… Verified tournament saved to database: new ObjectId("69750f25b359f0b73ed2c45c")

      at log (src/controllers/tournamentController.js:191:13)

  console.log
    Email service is ready

      at log (src/utils/emailService.js:31:15)

PASS test/matchController.test.js (5.232 s)
  Match Controller Tests
    POST /api/matches
      âˆš should create a match (1234 ms)
    GET /api/matches
      âˆš should get all matches (343 ms)
    GET /api/matches/:id
      âˆš should get a single match (146 ms)
    PUT /api/matches/:id
      âˆš should update a match (212 ms)
    DELETE /api/matches/:id
      âˆš should delete a match (165 ms)

PASS test/tournamentController.test.js (5.595 s)
  Tournament Controller Tests
    POST /api/tournaments
      âˆš should create a tournament as organizer (1433 ms)
      âˆš should fail to create tournament as regular user (222 ms)
    GET /api/tournaments
      âˆš should get all tournaments (246 ms)
    GET /api/tournaments/:id
      âˆš should get a single tournament (253 ms)
    PUT /api/tournaments/:id
      âˆš should update tournament as owner (267 ms)
    DELETE /api/tournaments/:id
      âˆš should delete tournament as owner (201 ms)

FAIL test/playerController.test.js (6.366 s)
  Player Controller Tests
    POST /api/players
      Ã— should create player profile (1494 ms)
      âˆš should prevent duplicate profile (331 ms)
    GET /api/players
      âˆš should list players (349 ms)
    GET /api/players/:id
      âˆš should get single player (282 ms)
    PUT /api/players/:id
      âˆš should update own profile (268 ms)
      âˆš should fail to update others profile (234 ms)
    DELETE /api/players/:id
      âˆš should allow admin to delete player (258 ms)
      âˆš should prevent regular user from deleting (220 ms)

  â— Player Controller Tests â€º POST /api/players â€º should create player profile

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 400

    [0m [90m 51 |[39m                 [33m.[39msend(playerData)[33m;[39m
     [90m 52 |[39m
    [31m[1m>[22m[39m[90m 53 |[39m             expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                                    [31m[1m^[22m[39m
     [90m 54 |[39m             expect(res[33m.[39mbody[33m.[39msuccess)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m 55 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39mdojo_name)[33m.[39mtoBe([32m'Test Dojo'[39m)[33m;[39m
     [90m 56 |[39m             expect(res[33m.[39mbody[33m.[39mdata[33m.[39muser_id)[33m.[39mtoBe(playerUser[33m.[39m_id[33m.[39mtoString())[33m;[39m[0m

      at Object.toBe (test/playerController.test.js:53:36)

-------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------
File                           | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                         
-------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------
All files                      |   21.86 |     4.06 |    9.72 |   22.17 |                                                                                                                                           
 src                           |   77.92 |     6.66 |      20 |   77.63 |                                                                                                                                           
  app.js                       |   77.92 |     6.66 |      20 |   77.63 | 56-62,81-111,118,149                                                                                                                      
 src/controllers               |   13.06 |     3.22 |    7.57 |    13.1 |                                                                                                                                           
  authController.js            |    5.52 |        0 |       0 |    5.88 | 15-468,476-562,570-608,616-622,630-731,739-768,776-819,827-917                                                                            
  categoryController.js        |   17.02 |        0 |       0 |   17.02 | 8-22,30-46,54-82,90-123,131-160                                                                                                           
  chatController.js            |    8.33 |        0 |       0 |    8.82 | 11-38,46-73,81-110,118-150,158-184,192-650                                                                                                
  coachController.js           |   18.75 |        0 |       0 |   18.75 | 9-44,52-68,76-105,113-142,150-167                                                                                                         
  dojoController.js            |   17.02 |        0 |       0 |   17.02 | 8-19,27-43,51-80,88-118,126-152                                                                                                           
  judgeController.js           |    18.6 |        0 |       0 |    18.6 | 8-19,27-43,51-80,88-117,125-142                                                                                                           
  kataPerformanceController.js |    5.02 |        0 |       0 |    5.27 | 13-66,74-112,120-262,268-273,281-799,811-822,828-873,880-955,963-1054,1062-1107,1115-1172                                                 
  kataReportController.js      |    8.33 |        0 |       0 |    8.77 | 11-253,261-281,289-303,311-337                                                                                                            
  kumiteReportController.js    |    6.38 |        0 |       0 |    6.74 | 13-422,430-450,458-472,480-509                                                                                                            
  matchController.js           |   20.04 |     9.24 |   23.25 |   19.82 | 49-53,71-75,90-118,129,144,190,207,219,232-245,259,269,281,297,305-414,438-439,455-456,465-470,484-503,517-573,582-796,805-1163,1171-1213 
  notificationController.js    |    14.7 |        0 |       0 |    14.7 | 8-35,43-66,74-86,94-119,127-155,163-174,182-207                                                                                           
  organizerController.js       |    18.6 |        0 |       0 |    18.6 | 8-19,27-43,51-80,88-117,125-142                                                                                                           
  paymentController.js         |   12.82 |        0 |       0 |   13.33 | 9-32,42-57,67-86,96-119,365-381,391-406,416-431,441-479                                                                                   
  playerController.js          |    61.9 |       24 |     100 |    61.9 | 21,35,46,57,77,95,108-131,156,168,181                                                                                                     
  registrationController.js    |    2.26 |        0 |       0 |     2.3 | 11-120,128-159,167-1306,1319-1441,1449-1660                                                                                               
  scoreController.js           |    9.48 |        0 |       0 |    9.64 | 11-30,38-56,64-230,238-286,294-322                                                                                                        
  tatamiController.js          |       8 |        0 |       0 |    8.18 | 13-40,48-145,153-248,256-301,309-377,385-477,485-548,556-628,636-685,693-755                                                              
  teamController.js            |   21.05 |        0 |       0 |   21.05 | 8-20,28-52,60-69,77-98,106-126                                                                                                            
  tournamentController.js      |   75.22 |    50.74 |     100 |   73.26 | 14,17,22-24,45,65,76,116,132-137,156,185-186,210-217,229,238,247,261,273,282,295                                                          
  userController.js            |   16.27 |        0 |       0 |   16.27 | 8-17,25-40,48-86,94-132                                                                                                                   
 src/middlewares               |   67.12 |       52 |     100 |   66.66 |                                                                                                                                           
  authMiddleware.js            |   77.77 |       70 |     100 |   77.77 | 14,28,37-43                                                                                                                               
  errorHandler.js              |   58.33 |       50 |     100 |   56.52 | 10-11,16-18,24-25,30-32                                                                                                                   
  optionalAuth.js              |      50 |       30 |     100 |      50 | 11,19-37                                                                                                                                  
  roleMiddleware.js            |    87.5 |       75 |     100 |    87.5 | 4                                                                                                                                         
  validateRequest.js           |   85.71 |       50 |     100 |   85.71 | 7                                                                                                                                         
 src/models                    |    71.2 |     4.16 |   11.11 |   73.55 |                                                                                                                                           
  ChatMessage.js               |     100 |      100 |     100 |     100 |                                                                                                                                           
  Coach.js                     |     100 |      100 |     100 |     100 |                                                                                                                                           
  Dojo.js                      |     100 |      100 |     100 |     100 |                                                                                                                                           
  Judge.js                     |     100 |      100 |     100 |     100 |                                                                                                                                           
  KataPerformance.js           |     100 |      100 |     100 |     100 |                                                                                                                                           
  KataReport.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  KumiteReport.js              |     100 |      100 |     100 |     100 |                                                                                                                                           
  Match.js                     |     100 |      100 |     100 |     100 |                                                                                                                                           
  MatchJudge.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  MatchParticipant.js          |     100 |      100 |     100 |     100 |                                                                                                                                           
  Notification.js              |     100 |      100 |     100 |     100 |                                                                                                                                           
  Organizer.js                 |     100 |      100 |     100 |     100 |                                                                                                                                           
  Payment.js                   |     100 |      100 |     100 |     100 |                                                                                                                                           
  Player.js                    |     100 |      100 |     100 |     100 |                                                                                                                                           
  Registration.js              |   20.93 |        0 |       0 |   23.07 | 107-182                                                                                                                                   
  Score.js                     |     100 |      100 |     100 |     100 |                                                                                                                                           
  Tatami.js                    |     100 |      100 |     100 |     100 |                                                                                                                                           
  Team.js                      |     100 |      100 |     100 |     100 |                                                                                                                                           
  TeamMember.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  Tournament.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  TournamentCategory.js        |     100 |      100 |     100 |     100 |                                                                                                                                           
  User.js                      |   83.33 |       50 |      50 |   83.33 | 86,95                                                                                                                                     
 src/routes                    |     100 |      100 |     100 |     100 |                                                                                                                                           
  authRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  categoryRoutes.js            |     100 |      100 |     100 |     100 |                                                                                                                                           
  chatRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  coachRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                           
  dojoRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  judgeRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                           
  kataPerformanceRoutes.js     |     100 |      100 |     100 |     100 |                                                                                                                                           
  kataReportRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                                           
  kumiteReportRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                                           
  matchRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                           
  notificationRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                                           
  organizerRoutes.js           |     100 |      100 |     100 |     100 |                                                                                                                                           
  paymentRoutes.js             |     100 |      100 |     100 |     100 |                                                                                                                                           
  playerRoutes.js              |     100 |      100 |     100 |     100 |                                                                                                                                           
  registrationRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                                           
  scoreRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                           
  tatamiRoutes.js              |     100 |      100 |     100 |     100 |                                                                                                                                           
  teamRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
  tournamentRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                                           
  userRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                           
 src/services                  |    7.79 |        0 |       0 |    8.05 |                                                                                                                                           
  drawGenerationService.js     |    7.18 |        0 |       0 |    7.78 | 19-328,336-489                                                                                                                            
  paymentService.js            |    8.23 |        0 |       0 |    8.23 | 21-22,37-40,56-362,376-636,649-663,673-687,697-708,722-739,752-761,774-788,797,802-822                                                    
 src/utils                     |   21.96 |    11.86 |   11.11 |   22.05 |                                                                                                                                           
  emailService.js              |   35.55 |    36.84 |      25 |   35.55 | 28-29,35,39-66,74-83,87-89,93-95,99-101,105-147                                                                                           
  geminiService.js             |    5.76 |        0 |       0 |    5.76 | 7-20,29-214,224-251                                                                                                                       
  generateToken.js             |    87.5 |       50 |     100 |    87.5 | 20                                                                                                                                        
  imageHandler.js              |   46.15 |    21.42 |       0 |      48 | 8,14-18,25-28,46-49,56-57                                                                                                                 
  payhere.js                   |   23.25 |       12 |       0 |   23.25 | 18-21,34-45,70-82,92,128-188,202-203                                                                                                      
  socket.js                    |   18.42 |        0 |       0 |   18.42 | 6-60,64-67,72-74,79-81,86-87                                                                                                              
 src/validations               |   32.72 |     3.22 |      25 |   32.72 |                                                                                                                                           
  registrationValidation.js    |   11.11 |        0 |       0 |   11.11 | 16-86                                                                                                                                     
  tournamentValidation.js      |   64.28 |       25 |   66.66 |   64.28 | 18,35,119-122                                                                                                                             
  userValidation.js            |     100 |      100 |     100 |     100 |                                                                                                                                           
-------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 1 failed, 2 passed, 3 total
Tests:       1 failed, 18 passed, 19 total
Snapshots:   0 total
Time:        7.441 s
Ran all test suites matching test/tournamentController.test.js|test/matchController.test.js|test/playerController.test.js.
