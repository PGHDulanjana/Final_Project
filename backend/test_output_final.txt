
> xpertkarate-backend@1.0.0 test
> cross-env NODE_ENV=test jest tests/integration/auth.test.js tests/integration/user.test.jsTests/integration/tournament.test.js tests/integration/match.test.js tests/integration/player.test.js

(node:9992) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:17220) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
(node:26932) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
  console.log
    üìù Backend - Creating user with data: {
      username: 'testuser',
      email: 'test@example.com',
      password_hash: '***hidden***',
      first_name: 'Test',
      last_name: 'User',
      user_type: 'Player',
      gender: 'Male',
      hasGender: true,
      genderValue: 'Male'
    }

      at log (src/controllers/authController.js:125:13)

  console.log
    ‚úÖ Backend - User created successfully: { userId: new ObjectId("6975139039b797da372a230b"), gender: 'Male' }

      at log (src/controllers/authController.js:135:15)

  console.log
    üîµ Player registration - Received data: {
      selected_coach_id: undefined,
      coach_id: '6975139039b797da372a22fd',
      player_dojo_name: 'Test Dojo',
      coach_name: undefined,
      user_id: new ObjectId("6975139039b797da372a230b")
    }

      at log (src/controllers/authController.js:203:15)

  console.log
    üîµ Player registration - Validated data: {
      finalCoachName: 'Test User',
      finalDojoName: 'Test Dojo',
      coach_id: new ObjectId("6975139039b797da372a22fd"),
      user_id: new ObjectId("6975139039b797da372a230b")
    }

      at log (src/controllers/authController.js:300:15)

  console.log
    ‚úÖ Player created successfully: {
      player_id: new ObjectId("6975139039b797da372a2325"),
      user_id: new ObjectId("6975139039b797da372a230b"),
      coach_name: 'Test User',
      dojo_name: 'Test Dojo',
      coach_id: new ObjectId("6975139039b797da372a22fd"),
      coach_id_type: 'object',
      coach_id_string: '6975139039b797da372a22fd'
    }

      at log (src/controllers/authController.js:400:17)

  console.log
    üìù Backend - Creating user with data: {
      username: 'testuser',
      email: 'test@example.com',
      password_hash: '***hidden***',
      first_name: 'Test',
      last_name: 'User',
      user_type: 'Player',
      gender: 'Male',
      hasGender: true,
      genderValue: 'Male'
    }

      at log (src/controllers/authController.js:125:13)

  console.log
    ‚úÖ Backend - User created successfully: { userId: new ObjectId("6975139039b797da372a2362"), gender: 'Male' }

      at log (src/controllers/authController.js:135:15)

  console.log
    üîµ Player registration - Received data: {
      selected_coach_id: undefined,
      coach_id: '6975139039b797da372a235f',
      player_dojo_name: 'Test Dojo',
      coach_name: undefined,
      user_id: new ObjectId("6975139039b797da372a2362")
    }

      at log (src/controllers/authController.js:203:15)

  console.log
    üîµ Player registration - Validated data: {
      finalCoachName: 'Test User',
      finalDojoName: 'Test Dojo',
      coach_id: new ObjectId("6975139039b797da372a235f"),
      user_id: new ObjectId("6975139039b797da372a2362")
    }

      at log (src/controllers/authController.js:300:15)

  console.log
    ‚úÖ Player created successfully: {
      player_id: new ObjectId("6975139139b797da372a2369"),
      user_id: new ObjectId("6975139039b797da372a2362"),
      coach_name: 'Test User',
      dojo_name: 'Test Dojo',
      coach_id: new ObjectId("6975139039b797da372a235f"),
      coach_id_type: 'object',
      coach_id_string: '6975139039b797da372a235f'
    }

      at log (src/controllers/authController.js:400:17)

  console.log
    üîÑ Checking if next round should be generated for Preliminary in category 697513904fd1d2bfe7ff9785

      at log (src/controllers/matchController.js:427:13)

  console.log
    üìä Found 1 match(es) in Preliminary round

      at log (src/controllers/matchController.js:459:13)

  console.log
    üìã Match order: To Update

      at log (src/controllers/matchController.js:460:13)

  console.warn
    ‚ö†Ô∏è Match To Update (697513904fd1d2bfe7ff9787) is completed but has no winner_id

    [0m [90m 510 |[39m       
     [90m 511 |[39m       [36mif[39m ([33m![39mcompletedMatch[33m.[39mwinner_id) {
    [31m[1m>[22m[39m[90m 512 |[39m         console[33m.[39mwarn([32m`‚ö†Ô∏è Match ${completedMatch.match_name} (${completedMatch._id}) is completed but has no winner_id`[39m)[33m;[39m
     [90m     |[39m                 [31m[1m^[22m[39m
     [90m 513 |[39m         [36mcontinue[39m[33m;[39m
     [90m 514 |[39m       }
     [90m 515 |[39m[0m

      at warn (src/controllers/matchController.js:512:17)

  console.log
    ‚ö†Ô∏è No winners found for Preliminary round in category 697513904fd1d2bfe7ff9785

      at log (src/controllers/matchController.js:578:15)

  console.log
    üìù Backend - Creating user with data: {
      username: 'testuser',
      email: 'test@example.com',
      password_hash: '***hidden***',
      first_name: 'Test',
      last_name: 'User',
      user_type: 'Player',
      gender: 'Male',
      hasGender: true,
      genderValue: 'Male'
    }

      at log (src/controllers/authController.js:125:13)

  console.log
    ‚úÖ Backend - User created successfully: { userId: new ObjectId("6975139139b797da372a2388"), gender: 'Male' }

      at log (src/controllers/authController.js:135:15)

  console.log
    üîµ Player registration - Received data: {
      selected_coach_id: undefined,
      coach_id: '6975139139b797da372a2385',
      player_dojo_name: 'Test Dojo',
      coach_name: undefined,
      user_id: new ObjectId("6975139139b797da372a2388")
    }

      at log (src/controllers/authController.js:203:15)

  console.log
    üîµ Player registration - Validated data: {
      finalCoachName: 'Test User',
      finalDojoName: 'Test Dojo',
      coach_id: new ObjectId("6975139139b797da372a2385"),
      user_id: new ObjectId("6975139139b797da372a2388")
    }

      at log (src/controllers/authController.js:300:15)

  console.log
    ‚úÖ Player created successfully: {
      player_id: new ObjectId("6975139139b797da372a238f"),
      user_id: new ObjectId("6975139139b797da372a2388"),
      coach_name: 'Test User',
      dojo_name: 'Test Dojo',
      coach_id: new ObjectId("6975139139b797da372a2385"),
      coach_id_type: 'object',
      coach_id_string: '6975139139b797da372a2385'
    }

      at log (src/controllers/authController.js:400:17)

  console.log
    üìù Backend - Creating user with data: {
      username: 'testuser',
      email: 'test@example.com',
      password_hash: '***hidden***',
      first_name: 'Test',
      last_name: 'User',
      user_type: 'Player',
      gender: 'Male',
      hasGender: true,
      genderValue: 'Male'
    }

      at log (src/controllers/authController.js:125:13)

  console.log
    ‚úÖ Backend - User created successfully: { userId: new ObjectId("6975139139b797da372a23ad"), gender: 'Male' }

      at log (src/controllers/authController.js:135:15)

  console.log
    üîµ Player registration - Received data: {
      selected_coach_id: undefined,
      coach_id: '6975139139b797da372a23aa',
      player_dojo_name: 'Test Dojo',
      coach_name: undefined,
      user_id: new ObjectId("6975139139b797da372a23ad")
    }

      at log (src/controllers/authController.js:203:15)

  console.log
    üîµ Player registration - Validated data: {
      finalCoachName: 'Test User',
      finalDojoName: 'Test Dojo',
      coach_id: new ObjectId("6975139139b797da372a23aa"),
      user_id: new ObjectId("6975139139b797da372a23ad")
    }

      at log (src/controllers/authController.js:300:15)

  console.log
    ‚úÖ Player created successfully: {
      player_id: new ObjectId("6975139139b797da372a23b4"),
      user_id: new ObjectId("6975139139b797da372a23ad"),
      coach_name: 'Test User',
      dojo_name: 'Test Dojo',
      coach_id: new ObjectId("6975139139b797da372a23aa"),
      coach_id_type: 'object',
      coach_id_string: '6975139139b797da372a23aa'
    }

      at log (src/controllers/authController.js:400:17)

PASS tests/integration/match.test.js
  Match Controller Tests
    POST /api/matches
      ‚àö should create a match (706 ms)
    GET /api/matches
      ‚àö should get all matches (191 ms)
    GET /api/matches/:id
      ‚àö should get a single match (133 ms)
    PUT /api/matches/:id
      ‚àö should update a match (198 ms)
    DELETE /api/matches/:id
      ‚àö should delete a match (137 ms)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Email service is ready".

    [0m[0m

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at src/utils/emailService.js:1117:15
      at finalize (node_modules/nodemailer/lib/smtp-transport/index.js:364:24)
      at node_modules/nodemailer/lib/smtp-transport/index.js:386:25
      at SMTPConnection._actionAUTHComplete (node_modules/nodemailer/lib/smtp-connection/index.js:1602:9)
      at SMTPConnection.<anonymous> (node_modules/nodemailer/lib/smtp-connection/index.js:556:26)
      at SMTPConnection._processResponse (node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
      at SMTPConnection._onData (node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
      at TLSSocket.SMTPConnection._onSocketData (node_modules/nodemailer/lib/smtp-connection/index.js:195:44)

  console.log
    Email service is ready

      at log (src/utils/emailService.js:31:15)

PASS tests/integration/auth.test.js
  Auth Controller Integration Tests
    POST /api/auth/register
      ‚àö should register a new user successfully (761 ms)
      ‚àö should fail if user already exists (176 ms)
    POST /api/auth/login
      ‚àö should login successfully with correct credentials (302 ms)
      ‚àö should fail with incorrect password (302 ms)
      ‚àö should fail with non-existent email (214 ms)


  ‚óè  Cannot log after tests are done. Did you forget to wait for something async in your test?
    Attempted to log "Email service is ready".

    [0m[0m

      at console.log (node_modules/@jest/console/build/index.js:311:10)
      at src/utils/emailService.js:1117:15
      at finalize (node_modules/nodemailer/lib/smtp-transport/index.js:364:24)
      at node_modules/nodemailer/lib/smtp-transport/index.js:386:25
      at SMTPConnection._actionAUTHComplete (node_modules/nodemailer/lib/smtp-connection/index.js:1602:9)
      at SMTPConnection.<anonymous> (node_modules/nodemailer/lib/smtp-connection/index.js:556:26)
      at SMTPConnection._processResponse (node_modules/nodemailer/lib/smtp-connection/index.js:993:20)
      at SMTPConnection._onData (node_modules/nodemailer/lib/smtp-connection/index.js:774:14)
      at TLSSocket.SMTPConnection._onSocketData (node_modules/nodemailer/lib/smtp-connection/index.js:195:44)

PASS tests/integration/player.test.js (5.315 s)
  Player Controller Tests
    POST /api/players
      ‚àö should create player profile (830 ms)
      ‚àö should prevent duplicate profile (255 ms)
    GET /api/players
      ‚àö should list players (329 ms)
    GET /api/players/:id
      ‚àö should get single player (255 ms)
    PUT /api/players/:id
      ‚àö should update own profile (255 ms)
      ‚àö should fail to update others profile (245 ms)
    DELETE /api/players/:id
      ‚àö should allow admin to delete player (273 ms)
      ‚àö should prevent regular user from deleting (236 ms)

-------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
File                           | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                                                                                           
-------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
All files                      |   21.63 |     4.72 |    7.77 |   22.13 |                                                                                                                                                                                                             
 src                           |   77.92 |     6.66 |      20 |   77.63 |                                                                                                                                                                                                             
  app.js                       |   77.92 |     6.66 |      20 |   77.63 | 56-62,81-111,118,149                                                                                                                                                                                        
 src/controllers               |   13.35 |     4.79 |    6.43 |   13.64 |                                                                                                                                                                                                             
  authController.js            |   30.67 |    22.36 |   18.18 |   32.35 | 52,60-67,98,102,109,141-164,170-197,213-214,221-222,235,244,271-273,285-286,293-294,313-314,319-324,331-337,339-352,378,396,410-441,468,481,499,522-532,562,570-608,616-622,630-731,739-768,776-819,827-917 
  categoryController.js        |   17.02 |        0 |       0 |   17.02 | 8-22,30-46,54-82,90-123,131-160                                                                                                                                                                             
  chatController.js            |    8.33 |        0 |       0 |    8.82 | 11-38,46-73,81-110,118-150,158-184,192-650                                                                                                                                                                  
  coachController.js           |   18.75 |        0 |       0 |   18.75 | 9-44,52-68,76-105,113-142,150-167                                                                                                                                                                           
  dojoController.js            |   17.02 |        0 |       0 |   17.02 | 8-19,27-43,51-80,88-118,126-152                                                                                                                                                                             
  judgeController.js           |    18.6 |        0 |       0 |    18.6 | 8-19,27-43,51-80,88-117,125-142                                                                                                                                                                             
  kataPerformanceController.js |    5.02 |        0 |       0 |    5.27 | 13-66,74-112,120-262,268-273,281-799,811-822,828-873,880-955,963-1054,1062-1107,1115-1172                                                                                                                   
  kataReportController.js      |    8.33 |        0 |       0 |    8.77 | 11-253,261-281,289-303,311-337                                                                                                                                                                              
  kumiteReportController.js    |    6.38 |        0 |       0 |    6.74 | 13-422,430-450,458-472,480-509                                                                                                                                                                              
  matchController.js           |   20.04 |     9.24 |   23.25 |   19.82 | 49-53,71-75,90-118,129,144,190,207,219,232-245,259,269,281,297,305-414,438-439,455-456,465-470,484-503,517-573,582-796,805-1163,1171-1213                                                                   
  notificationController.js    |    14.7 |        0 |       0 |    14.7 | 8-35,43-66,74-86,94-119,127-155,163-174,182-207                                                                                                                                                             
  organizerController.js       |    18.6 |        0 |       0 |    18.6 | 8-19,27-43,51-80,88-117,125-142                                                                                                                                                                             
  paymentController.js         |   12.82 |        0 |       0 |   13.33 | 9-32,42-57,67-86,96-119,365-381,391-406,416-431,441-479                                                                                                                                                     
  playerController.js          |    61.9 |       24 |     100 |    61.9 | 21,35,46,57,83,95,108-131,156,168,181                                                                                                                                                                       
  registrationController.js    |    2.26 |        0 |       0 |     2.3 | 11-120,128-159,167-1306,1319-1441,1449-1660                                                                                                                                                                 
  scoreController.js           |    9.48 |        0 |       0 |    9.64 | 11-30,38-56,64-230,238-286,294-322                                                                                                                                                                          
  tatamiController.js          |       8 |        0 |       0 |    8.18 | 13-40,48-145,153-248,256-301,309-377,385-477,485-548,556-628,636-685,693-755                                                                                                                                
  teamController.js            |   21.05 |        0 |       0 |   21.05 | 8-20,28-52,60-69,77-98,106-126                                                                                                                                                                              
  tournamentController.js      |    8.25 |        0 |       0 |    8.91 | 9-45,53-76,84-217,225-261,269-295                                                                                                                                                                           
  userController.js            |   16.27 |        0 |       0 |   16.27 | 8-17,25-40,48-86,94-132                                                                                                                                                                                     
 src/middlewares               |    45.2 |       22 |   57.14 |   45.83 |                                                                                                                                                                                                             
  authMiddleware.js            |   77.77 |       70 |     100 |   77.77 | 14,28,37-43                                                                                                                                                                                                 
  errorHandler.js              |    8.33 |        0 |       0 |    8.69 | 2-41                                                                                                                                                                                                        
  optionalAuth.js              |      25 |        0 |       0 |      25 | 6-37                                                                                                                                                                                                        
  roleMiddleware.js            |    87.5 |       75 |     100 |    87.5 | 4                                                                                                                                                                                                           
  validateRequest.js           |   85.71 |       50 |     100 |   85.71 | 7                                                                                                                                                                                                           
 src/models                    |      72 |     4.16 |   22.22 |   74.38 |                                                                                                                                                                                                             
  ChatMessage.js               |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Coach.js                     |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Dojo.js                      |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Judge.js                     |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  KataPerformance.js           |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  KataReport.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  KumiteReport.js              |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Match.js                     |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  MatchJudge.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  MatchParticipant.js          |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Notification.js              |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Organizer.js                 |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Payment.js                   |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Player.js                    |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Registration.js              |   20.93 |        0 |       0 |   23.07 | 107-182                                                                                                                                                                                                     
  Score.js                     |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Tatami.js                    |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Team.js                      |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  TeamMember.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  Tournament.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  TournamentCategory.js        |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  User.js                      |   91.66 |       50 |     100 |   91.66 | 86                                                                                                                                                                                                          
 src/routes                    |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  authRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  categoryRoutes.js            |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  chatRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  coachRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  dojoRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  judgeRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  kataPerformanceRoutes.js     |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  kataReportRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  kumiteReportRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  matchRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  notificationRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  organizerRoutes.js           |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  paymentRoutes.js             |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  playerRoutes.js              |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  registrationRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  scoreRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  tatamiRoutes.js              |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  teamRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  tournamentRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
  userRoutes.js                |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
 src/services                  |    7.79 |        0 |       0 |    8.05 |                                                                                                                                                                                                             
  drawGenerationService.js     |    7.18 |        0 |       0 |    7.78 | 19-328,336-489                                                                                                                                                                                              
  paymentService.js            |    8.23 |        0 |       0 |    8.23 | 21-22,37-40,56-362,376-636,649-663,673-687,697-708,722-739,752-761,774-788,797,802-822                                                                                                                      
 src/utils                     |   21.96 |    11.86 |   11.11 |   22.05 |                                                                                                                                                                                                             
  emailService.js              |   35.55 |    36.84 |      25 |   35.55 | 28-29,35,39-66,74-83,87-89,93-95,99-101,105-147                                                                                                                                                             
  geminiService.js             |    5.76 |        0 |       0 |    5.76 | 7-20,29-214,224-251                                                                                                                                                                                         
  generateToken.js             |    87.5 |       50 |     100 |    87.5 | 20                                                                                                                                                                                                          
  imageHandler.js              |   46.15 |    21.42 |       0 |      48 | 8,14-18,25-28,46-49,56-57                                                                                                                                                                                   
  payhere.js                   |   23.25 |       12 |       0 |   23.25 | 18-21,34-45,70-82,92,128-188,202-203                                                                                                                                                                        
  socket.js                    |   18.42 |        0 |       0 |   18.42 | 6-60,64-67,72-74,79-81,86-87                                                                                                                                                                                
 src/validations               |   25.45 |        0 |       0 |   25.45 |                                                                                                                                                                                                             
  registrationValidation.js    |   11.11 |        0 |       0 |   11.11 | 16-86                                                                                                                                                                                                       
  tournamentValidation.js      |   35.71 |        0 |       0 |   35.71 | 17-37,119-122                                                                                                                                                                                               
  userValidation.js            |     100 |      100 |     100 |     100 |                                                                                                                                                                                                             
-------------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Test Suites: 3 passed, 3 total
Tests:       18 passed, 18 total
Snapshots:   0 total
Time:        6.565 s, estimated 8 s
Ran all test suites matching tests/integration/auth.test.js|tests/integration/user.test.jsTests/integration/tournament.test.js|tests/integration/match.test.js|tests/integration/player.test.js.
